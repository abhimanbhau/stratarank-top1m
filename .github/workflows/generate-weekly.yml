name: Generate Composite Top 1M Domains List

on:
  schedule:
    # Every Monday at 00:00 UTC
    - cron: '0 0 * * 1'
  workflow_dispatch:

jobs:
  generate:
    name: Generate Composite List
    runs-on: ubuntu-latest

    permissions:
      contents: write
      actions: read

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Dependencies
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Generate Composite List
        id: generate
        shell: bash
        run: |
          set -euo pipefail
          echo "Starting domain list generation..."
          python generate_composite_top1m.py

          # Resolve outputs
          SIMPLE_FILE="$(ls -t composite_top1m_*.csv 2>/dev/null | grep -v full | head -1 || true)"
          FULL_FILE="$(ls -t composite_top1m_full_*.csv 2>/dev/null | head -1 || true)"

          if [[ -z "${SIMPLE_FILE:-}" || -z "${FULL_FILE:-}" ]]; then
            echo "No output files found"; ls -la; exit 1
          fi

          TIMESTAMP="$(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          SIMPLE_SIZE="$(wc -l < "$SIMPLE_FILE" || echo 0)"
          FULL_SIZE="$(wc -l < "$FULL_FILE" || echo 0)"

          {
            echo "simple_file=$SIMPLE_FILE"
            echo "full_file=$FULL_FILE"
            echo "timestamp=$TIMESTAMP"
            echo "simple_size=$SIMPLE_SIZE"
            echo "full_size=$FULL_SIZE"
          } >> "$GITHUB_OUTPUT"

          echo "✓ Generation complete"

      - name: Summary
        shell: bash
        run: |
          set -euo pipefail
          SIMPLE="${{ steps.generate.outputs.simple_file }}"
          FULL="${{ steps.generate.outputs.full_file }}"
          TS="${{ steps.generate.outputs.timestamp }}"
          TOTAL="${{ steps.generate.outputs.simple_size }}"

          # Write summary
          cat >> "$GITHUB_STEP_SUMMARY" << 'EOF'
          ## ✅ Composite List Generation Complete
          EOF
          
          echo "**Timestamp**: ${TS}" >> "$GITHUB_STEP_SUMMARY"
          echo "**Total Domains**: ${TOTAL}" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          
          cat >> "$GITHUB_STEP_SUMMARY" << 'EOF'
          ### Top 10 Domains
          ```
          EOF
          
          head -10 "$SIMPLE" >> "$GITHUB_STEP_SUMMARY"
          
          cat >> "$GITHUB_STEP_SUMMARY" << EOF
          \`\`\`

          ### Files
          - Simple: \`$SIMPLE\`
          - Full: \`$FULL\`
          EOF

      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ${{ steps.generate.outputs.simple_file }}
            ${{ steps.generate.outputs.full_file }}
          tag_name: composite-${{ github.run_number }}-${{ github.run_id }}
          name: "Composite Top 1M Domains - ${{ steps.generate.outputs.timestamp }}"
          body: |
            ## Weekly Composite Top 1M Domain List

            Generated: ${{ steps.generate.outputs.timestamp }}

            ### What's Included
            - composite_top1m_*.csv — Simple format (rank,domain)
            - composite_top1m_full_*.csv — Full format with metadata (rank,domain,score,appearances)

            ### Statistics
            - Total domains: ${{ steps.generate.outputs.simple_size }}
            - Simple CSV: ${{ steps.generate.outputs.simple_file }}
            - Full CSV: ${{ steps.generate.outputs.full_file }}

            ### Methodology
            Dowdall scoring with weighted averaging (research-grounded aggregation).

            ### Important
            Read LEGAL_NOTICE.md before use; repository includes AI-generated code and provides no warranty.

            ---
            Repository: https://github.com/${{ github.repository }}
            Workflow: .github/workflows/generate-weekly.yml
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Artifacts (v4)
        uses: actions/upload-artifact@v4
        with:
          name: composite-${{ github.run_number }}-${{ github.run_id }}
          path: |
            ${{ steps.generate.outputs.simple_file }}
            ${{ steps.generate.outputs.full_file }}
          retention-days: 30
          if-no-files-found: error

      - name: Cleanup Old Releases (keep last 12)
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          echo "Cleaning up old releases (keeping last 12)..."
          gh release list --limit 100 --json name,createdAt \
            --jq 'sort_by(.createdAt) | reverse | .[12:] | .[].name' \
            | while read -r release; do
                echo "Deleting old release: $release"
                gh release delete "$release" --cleanup-tag --yes || true
              done

  notify:
    name: Notify Completion
    runs-on: ubuntu-latest
    needs: generate
    if: always()
    steps:
      - name: Check Job Status
        run: |
          if [ "${{ needs.generate.result }}" = "success" ]; then
            echo "✅ Generation successful"
          else
            echo "❌ Generation failed"
            exit 1
          fi
